# Extism 插件生态系统实现计划

## 1. 现状分析

### 1.1 已实现功能

- ✅ 多语言 PDK 支持 (TypeScript, Go, Python, Rust, C/C++)
- ✅ 基本插件注册表功能
- ✅ 插件签名与验证
- ✅ Mastra 工具集成
- ✅ 企业支持系统
- ✅ 社区平台
- ✅ 完整包管理系统与依赖解析
- ✅ 高级搜索与发现功能
- ✅ 用户身份验证系统

### 1.2 功能缺口

- ❌ 插件安装与使用的简化流程
- ❌ 企业级部署方案
- ❌ 社区与论坛功能

## 2. Next.js 插件仓库实现方案

### 2.1 技术栈选择

- **前端框架**: Next.js 14+ (App Router) ✅
- **UI 库**: Tailwind CSS + Shadcn UI ✅
- **API 实现**: Next.js API Routes ✅
- **数据存储**: 
  - 结构化数据模拟 ✅
  - 文件系统存储 (插件包存储) ✅
- **身份验证**: NextAuth.js ✅
- **CI/CD**: GitHub Actions
- **搜索引擎**: 基础搜索功能 ✅
- **包管理与依赖解析**: 冲突解决算法 ✅

### 2.2 系统架构

```
┌─────────────────────────────────────────────┐
│               Client Browsers                │
└───────────────────────┬─────────────────────┘
                        │
┌───────────────────────▼─────────────────────┐
│                  Next.js App                 │
│  ┌─────────┐  ┌─────────┐  ┌─────────────┐  │
│  │ Web UI  │  │ API     │  │ tRPC Routes │  │
│  └─────────┘  └─────────┘  └─────────────┘  │
└───────────────────┬─────────────────────────┘
                    │
┌───────────────────▼─────────────────────────┐
│               Service Layer                  │
│  ┌─────────┐  ┌─────────┐  ┌─────────────┐  │
│  │ Auth    │  │ Package │  │ Analytics   │  │
│  │ Service │  │ Service │  │ Service     │  │
│  └─────────┘  └─────────┘  └─────────────┘  │
└───────────────────┬─────────────────────────┘
                    │
┌───────────────────▼─────────────────────────┐
│              Storage Layer                   │
│  ┌─────────┐  ┌─────────┐  ┌─────────────┐  │
│  │ Postgres│  │ Redis   │  │ S3 Storage  │  │
│  └─────────┘  └─────────┘  └─────────────┘  │
└─────────────────────────────────────────────┘
```

### 2.3 数据模型

```typescript
// 核心实体模型
interface User {
  id: string;
  username: string;
  email: string;
  avatarUrl?: string;
  organizations: Organization[];
  createdAt: Date;
  updatedAt: Date;
}

interface Organization {
  id: string;
  name: string;
  slug: string;
  avatarUrl?: string;
  members: User[];
  packages: Package[];
  createdAt: Date;
  updatedAt: Date;
}

interface Package {
  id: string;
  name: string;
  scope?: string; // 组织范围
  description?: string;
  versions: PackageVersion[];
  maintainers: User[];
  organization?: Organization;
  downloads: number;
  repository?: string;
  homepage?: string;
  license?: string;
  keywords: string[];
  createdAt: Date;
  updatedAt: Date;
}

interface PackageVersion {
  id: string;
  packageId: string;
  version: string; // 语义化版本
  description?: string;
  dependencies: Record<string, string>;
  devDependencies: Record<string, string>;
  peerDependencies: Record<string, string>;
  dist: {
    shasum: string;
    tarball: string; // S3 URL
    size: number;
    signatures: Signature[];
  };
  language: "typescript" | "go" | "python" | "rust" | "cpp";
  engines?: Record<string, string>;
  readme?: string;
  author?: string;
  maintainers: User[];
  publishedAt: Date;
}

interface Signature {
  keyid: string;
  sig: string;
}
```

## 3. 前端实现

### 3.1 页面结构

- **主页** (`/`)
  - 最新插件
  - 热门插件
  - 插件分类导航
  - 搜索功能
- **插件详情** (`/packages/[name]`)
  - 基本信息
  - 安装指南
  - 版本历史
  - README 展示
  - 依赖图表
  - 下载统计
- **插件搜索** (`/search`)
  - 高级搜索选项
  - 语言筛选
  - 分类筛选
- **用户管理** (`/account/*`)
  - 个人资料
  - 我的插件
  - 组织管理
- **插件发布** (`/publish`)
  - 上传表单
  - 元数据编辑
  - 验证与预览
- **文档** (`/docs/*`)
  - 使用指南
  - API 文档
  - PDK 文档
- **管理面板** (`/admin/*`)
  - 用户管理
  - 插件审核
  - 统计报表

### 3.2 设计规范

- 响应式设计，支持移动端和桌面端
- 深色模式和浅色模式支持
- 可访问性优化，符合 WCAG 2.1 AA 标准
- 多语言支持 (英文和中文)

## 4. 后端实现

### 4.1 API 路由

- **身份验证** ✅
  - `/api/auth/*` - NextAuth.js 路由 ✅
  - `/api/token` - API 令牌管理 ✅
  
- **插件管理**
  - `/api/packages` - 插件列表和搜索
  - `/api/packages/[name]` - 插件详情
  - `/api/packages/[name]/versions` - 版本列表
  - `/api/packages/[name]/versions/[version]` - 版本详情
  - `/api/packages/[name]/download` - 下载插件
  - `/api/packages/[name]/stats` - 插件统计

- **用户和组织**
  - `/api/users/[username]` - 用户信息
  - `/api/users/[username]/packages` - 用户插件
  - `/api/orgs/[orgname]` - 组织信息
  - `/api/orgs/[orgname]/members` - 组织成员
  - `/api/orgs/[orgname]/packages` - 组织插件

- **管理**
  - `/api/admin/users` - 用户管理
  - `/api/admin/packages` - 插件管理
  - `/api/admin/stats` - 系统统计

### 4.2 CLI 客户端实现

基于现有的 `registry-cli.ts` 实现增强的命令行工具：

```typescript
// 支持的命令
interface CliCommands {
  login: () => Promise<void>;       // 登录注册表
  logout: () => Promise<void>;      // 登出注册表
  publish: () => Promise<void>;     // 发布插件
  install: () => Promise<void>;     // 安装插件
  update: () => Promise<void>;      // 更新插件
  search: () => Promise<void>;      // 搜索插件
  info: () => Promise<void>;        // 查看插件信息
  list: () => Promise<void>;        // 列出已安装插件
  create: () => Promise<void>;      // 创建新插件项目
  test: () => Promise<void>;        // 测试插件
  init: () => Promise<void>;        // 初始化配置
  config: () => Promise<void>;      // 配置管理
}
```

## 5. 插件依赖管理优化

### 5.1 依赖冲突解决 ✅

- **命名空间隔离**：实现类似 "Mozart" 的命名空间前缀技术 ✅
- **版本共存**：支持同一插件的多版本并存 ✅
- **智能解析算法**：基于函数级可达性分析的依赖优先级机制 ✅

### 5.2 依赖沙箱化 ✅

- 每个插件运行在独立的 WebAssembly 隔离环境中 ✅
- 实现资源访问控制和限制 ✅
- 提供插件间受控通信机制 ✅

### 5.3 缓存优化 ✅

- 实现多级缓存策略 ✅
- 支持增量更新 ✅
- 智能预加载常用依赖 ✅

## 6. 语言工具链实现

### 6.1 TypeScript 工具链

```typescript
// TypeScript 插件构建工具
interface TsToolchain {
  init: (options: InitOptions) => Promise<void>;    // 初始化项目
  build: (options: BuildOptions) => Promise<void>;  // 构建插件
  test: (options: TestOptions) => Promise<void>;    // 测试插件
  lint: (options: LintOptions) => Promise<void>;    // 代码检查
  format: (options: FormatOptions) => Promise<void>; // 代码格式化
  publish: (options: PublishOptions) => Promise<void>; // 发布插件
}